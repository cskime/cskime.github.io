<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>[Dart] Understanding null safety | cskime.io</title>
<meta name="keywords" content="dart, null safety, flow analysis, type promotion">
<meta name="description" content="Overview 이 글은 Understanding null safety 문서의 내용을 바탕으로 Dart에서 null safety가 나온 배경 및 null safety의 동작 방식을 쉽게 이해하기 위해 작성하였다. 기본 문법적인 설명들을 제외하고 null safety의 원리를 이해하는데 필요하다고 생각되는 부분들만 정리했기 때문에 원문의 일부 내용이 누락되어 있고 설명하는 순서도 다르다. 빠르게 Dart null safety의 동작 방식에 대해 이해하는 것이 목적이라면 이 글을 이해하는 것으로 충분하겠지만, 더 자세한 설명이 필요하다면 원문을 정독하는 것을 권한다. Null safety가 나온 이유 Dart에서 null은 Null type으로 표현된다.">
<meta name="author" content="">
<link rel="canonical" href="https://cskime.github.io/posts/dart-understanding-null-safety/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.fc220c15db4aef0318bbf30adc45d33d4d7c88deff3238b23eb255afdc472ca6.css" integrity="sha256-/CIMFdtK7wMYu/MK3EXTPU18iN7/MjiyPrJVr9xHLKY=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://cskime.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://cskime.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://cskime.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://cskime.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://cskime.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://cskime.github.io/posts/dart-understanding-null-safety/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css"
  integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ"
  crossorigin="anonymous"
/>

<script
  defer
  src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.js"
  integrity="sha384-VQ8d8WVFw0yHhCk5E8I86oOhv48xLpnDZx5T9GogA/Y84DcCKWXDmSDfn13bzFZY"
  crossorigin="anonymous"
></script>

<script
  defer
  src="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/contrib/auto-render.min.js"
  integrity="sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR"
  crossorigin="anonymous"
  onload="renderMathInElement(document.body);"
></script>


<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
      ],
    });
  });
</script>


  

<meta property="og:title" content="[Dart] Understanding null safety" />
<meta property="og:description" content="Overview 이 글은 Understanding null safety 문서의 내용을 바탕으로 Dart에서 null safety가 나온 배경 및 null safety의 동작 방식을 쉽게 이해하기 위해 작성하였다. 기본 문법적인 설명들을 제외하고 null safety의 원리를 이해하는데 필요하다고 생각되는 부분들만 정리했기 때문에 원문의 일부 내용이 누락되어 있고 설명하는 순서도 다르다. 빠르게 Dart null safety의 동작 방식에 대해 이해하는 것이 목적이라면 이 글을 이해하는 것으로 충분하겠지만, 더 자세한 설명이 필요하다면 원문을 정독하는 것을 권한다. Null safety가 나온 이유 Dart에서 null은 Null type으로 표현된다." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://cskime.github.io/posts/dart-understanding-null-safety/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-09-15T15:25:01+09:00" />
<meta property="article:modified_time" content="2024-09-15T15:25:01+09:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="[Dart] Understanding null safety"/>
<meta name="twitter:description" content="Overview 이 글은 Understanding null safety 문서의 내용을 바탕으로 Dart에서 null safety가 나온 배경 및 null safety의 동작 방식을 쉽게 이해하기 위해 작성하였다. 기본 문법적인 설명들을 제외하고 null safety의 원리를 이해하는데 필요하다고 생각되는 부분들만 정리했기 때문에 원문의 일부 내용이 누락되어 있고 설명하는 순서도 다르다. 빠르게 Dart null safety의 동작 방식에 대해 이해하는 것이 목적이라면 이 글을 이해하는 것으로 충분하겠지만, 더 자세한 설명이 필요하다면 원문을 정독하는 것을 권한다. Null safety가 나온 이유 Dart에서 null은 Null type으로 표현된다."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://cskime.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "[Dart] Understanding null safety",
      "item": "https://cskime.github.io/posts/dart-understanding-null-safety/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "[Dart] Understanding null safety",
  "name": "[Dart] Understanding null safety",
  "description": "Overview 이 글은 Understanding null safety 문서의 내용을 바탕으로 Dart에서 null safety가 나온 배경 및 null safety의 동작 방식을 쉽게 이해하기 위해 작성하였다. 기본 문법적인 설명들을 제외하고 null safety의 원리를 이해하는데 필요하다고 생각되는 부분들만 정리했기 때문에 원문의 일부 내용이 누락되어 있고 설명하는 순서도 다르다. 빠르게 Dart null safety의 동작 방식에 대해 이해하는 것이 목적이라면 이 글을 이해하는 것으로 충분하겠지만, 더 자세한 설명이 필요하다면 원문을 정독하는 것을 권한다. Null safety가 나온 이유 Dart에서 null은 Null type으로 표현된다.",
  "keywords": [
    "dart", "null safety", "flow analysis", "type promotion"
  ],
  "articleBody": "Overview 이 글은 Understanding null safety 문서의 내용을 바탕으로 Dart에서 null safety가 나온 배경 및 null safety의 동작 방식을 쉽게 이해하기 위해 작성하였다. 기본 문법적인 설명들을 제외하고 null safety의 원리를 이해하는데 필요하다고 생각되는 부분들만 정리했기 때문에 원문의 일부 내용이 누락되어 있고 설명하는 순서도 다르다. 빠르게 Dart null safety의 동작 방식에 대해 이해하는 것이 목적이라면 이 글을 이해하는 것으로 충분하겠지만, 더 자세한 설명이 필요하다면 원문을 정독하는 것을 권한다. Null safety가 나온 이유 Dart에서 null은 Null type으로 표현된다. Null safety 도입 전에는 Dart type system에서 Null이 다른 모든 type들의 subtype 이었다. 그래서 type에 상관 없이 변수에 null을 할당할 수 있었다. String value = \"hello\"; value = null; 이렇게 동작할 때 문제는 어떤 변수에 할당된 값이 null인지 아닌지 명확하게 알 수 없다는 것이다. 만약 변수에 null이 할당된 것을 모르고 해당 변수의 값을 참조하면 runtime에 null reference exception이 발생하며 app이 crash 될 것이다. String value = null; value.length; // ❌ : null reference error Null safety는 nullable한 변수를 null-safe하게 참조할 수 있는 방법을 제공한다. Nullable type과 non-nullable type Null safety는 Dart type system의 구조를 변경하여 Null type이 다른 type들의 subtype이 아닌 독립적인 type으로 존재하도록 하여 문제를 해결한다. 여기서 Null에 독립적으로 type graph를 이루는 type들을 non-nullable type으로 분류한다. Non-nullable type들은 Null type과 연관이 없으므로 절대로 null 값을 가질 수 없다. null값을 가질 수 있는 type들은 nullable type으로 분류한다. Nullable type은 underlying type과 Null type의 supertype으로, underlying type 뒤에 ? mark를 붙여서 표현한다. 이것은 nullable type이 non-null 또는 null 값 모두 가질 수 있음을 의미한다. 즉, null safety 도입 이후 Dart의 type은 아래와 같이 nullable type과 non-nullable type 두 그룹으로 분류된다. Type promotion과 null safety Type promotion Type promotion이란, if 등 control flow에서 is 연산자로 어떤 변수의 type을 특정할 수 있으면 control flow body 안에서 해당 변수의 type을 is로 검사한 type으로 취급(promote)하는 것을 말한다. bool isEmptyList(Object object) { if (object is List) { return object.isEmpty; // ✅ : `object`가 `List` type인 것을 안다. } else { return false; } } Null safety가 도입되기 전의 type promotion은 제한적이어서, 아래와 같이 is! 연산자를 사용한 반대 상황에서는 동작하지 않았다. // Without null safety: bool isEmptyList(Object object) { if (object is! List) return false; return object.isEmpty; // ❌ } Null safety를 도입하기 전에는 object가 List type이라는 것을 Dart가 알지 못했기 때문에 위 코드는 실행되지 못했다. Null safety에 type promotion을 도입하기 전에, 이러한 type promotion의 한계를 먼저 해결했다. 따라서, 위 코드가 동작하려면 null safety를 사용해야 한다. Null safety를 도입한 후에는 개선된 type promotion을 사용하여 위 코드가 정상적으로 실행될 수 있다. // Using null safety: bool isEmptyList(Object object) { if (object is! List) return false; return object.isEmpty; // ✅ : `object`가 `List` type인 것을 안다. } 기존 type promotion이 early return 및 unreachable code path에 대해서 잘 동작하지 않았던 문제가 개선됐다. 개선된 type promotion은 return, break, throw 및 함수에서 early terminate로 동작하는 code를 인식한다. Type promotion on null checks Type promotion이 is 연산자 외에 == null 및 != null 구문을 통한 null check도 인식하도록 기능이 추가되었다.\n// Using null safety: String makeCommand(String executable, [List\u003cString\u003e? arguments]) { var result = executable; if (arguments != null) { result += ' ' + arguments.join(' '); // ✅ : `arguments`가 `null`이 아닌 것을 안다. } return result; } // or // Using null safety: String makeCommand(String executable, [List\u003cString\u003e? arguments]) { var result = executable; if (arguments == null) return result; return result + ' ' + arguments.join(' '); // ✅ : `arguments`가 `null`이 아닌 것을 안다. } Type promotion은 아래 두 가지 경우에만 사용할 수 있다.\nLocal variable Private final field (Dart 3.2) 위 두 가지 조건은 if condition 안에서 null이 아니었는데 control flow body 에서 다시 null이 되는 상황을 만들지 않는 조건이다.\n간혹 if문 안에서 null check를 했는데도 promotion이 안될 때가 있는데, 이 두 가지 조건을 만족하지 않는 변수 또는 field를 사용했을 것이다. 아래 코드는 _temperature가 final field가 아니기 때문에 promotion이 동작하지 않아 error가 발생한다.\n// Using null safety, incorrectly: class Coffee { String? _temperature; void checkTemp() { if (_temperature != null) { print('Ready to serve ' + _temperature + '!'); // ❌ : _temperature isn't final } } } 변수 또는 field를 위 조건을 만족하도록 수정하기 어렵다면, local variable로 한 번 복사하는 pattern을 사용할 수 있다. 실제로 null check를 하는 대상이 local variable이 되어 promotion이 동작할 수 있다.\n// Using null safety, incorrectly: class Coffee { String? _temperature; void checkTemp() { var temperature = _temperature; if (_temperature != null) { print('Ready to serve ' + _temperature + '!'); // ✅ } } } Type promotion이 실패했을 때 수정하는 더 자세한 방법은 Fixing type promotion failures 문서를 참고해 보면 좋다.\nWorking with nullable types Nullable type이 null이 아닌 값을 가지고 있을 때, 이 non-null 값을 안전하게 사용하는 방법들을 정리한다. Null-aware operator와 Short-Circuit(단락) Null safety 도입 이전에는 null aware operator(?.)를 사용해서 nullable 변수에 저장된 non-null value를 안전하게 사용할 수 있었다. 이 연산자의 왼쪽 receiver가 null을 반환하면 오른쪽 구문의 실행을 건너뛰고 전체 구문을 null로 평가하여 exception 없이 null을 반환한다. // With or without null safety: String notAString = null; print(notAString?.length); // null 그런데, 아래와 같이 ?. 연산자를 연달아 사용하는 경우 문제가 생긴다. 두 번째로 사용된 ?. 연산자가 어떤 구문을 위해 사용된 것인지 모호해진다. // Using null safety: void showGizmo(Thing? thing) { print(thing?.doohickey?.gizmo); } doohickey가 nullable field라면 ?. 연산자는 doohickey를 위해 사용된 것일 수 있다. doohickey가 non-nullable field라면 ?. 연산자는 thing?.doohickey를 위해 사용된 것일 수 있다. 이 문제를 해결하기 위해 receiver가 null로 평가되는 경우 구문의 나머지 chain에 대한 실행을 생략하는 short-circut 방식을 사용한다. 이 방법을 사용함으로써 위 코드에서 두 번째 ?.는 doohickey가 nullable type이기 때문에 사용된 것임을 알 수 있다. Non-null assertion operator Nullable type이지만 null이 될 수 없음을 보장할 수 있는 변수는 assertion을 통해 non-null value를 사용할 수 있다. as cast operator를 사용해서 nullable type이 갖고 있는 non-null value를 가져올 수 있다. String? value = \"hello\"; (value as String).toUpperCase(); // HELLO Nullable type은 underlying type과 Null type의 supertype 이다. 따라서, nullable type을 underlying type으로 downcasting 할 수 있다. ! 연산자는 왼쪽 구문을 underlying type으로 cast해 주는 축약 문법이다. 즉, as cast와 동일하게 동작한다. String? value = \"hello\"; value!.toUpperCase(); // HELLO Nullable type 변수에 null이 할당되어 있을 때, as cast는 exception을 발생시키지 않고 null을 반환하지만 ! 연산자는 exception을 발생시키므로 사용에 주의한다. Conclusion Dart가 type system을 기반으로 null safety를 지원하는 방식을 깊이 이해할 수 있었다. 이 문서를 통해 flow analysis나 type promotion 등의 개념을 추가로 배울 수 있었다. 각각의 개념들이 null safety를 구현하는데 자주 언급되었기 떄문에 다시 개별적으로 더 공부해야 할 것 같다. 최근 진행한 면접에서 Dart의 type promotion이 가끔 동작하지 않는 이유에 대해 대답하지 못했는데 이 문서를 통해 답을 찾을 수 있었다. Local variable과 private final field에 대해서만 type promotion이 동작한다는 것을 알게 되었으므로, 이제 type promotion이 동작하지 않는 문제를 해결할 수 있다. ",
  "wordCount" : "1075",
  "inLanguage": "en",
  "datePublished": "2024-09-15T15:25:01+09:00",
  "dateModified": "2024-09-15T15:25:01+09:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://cskime.github.io/posts/dart-understanding-null-safety/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "cskime.io",
    "logo": {
      "@type": "ImageObject",
      "url": "https://cskime.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://cskime.github.io/" accesskey="h" title="cskime.io (Alt + H)">cskime.io</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://cskime.github.io/archive" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://cskime.github.io/tags" title="tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="https://cskime.github.io/search" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      [Dart] Understanding null safety
    </h1>
    <div class="post-meta"><span title='2024-09-15 15:25:01 +0900 KST'>September 15, 2024</span>&nbsp;·&nbsp;6 min

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#overview" aria-label="Overview">Overview</a></li>
                <li>
                    <a href="#null-safety%ea%b0%80-%eb%82%98%ec%98%a8-%ec%9d%b4%ec%9c%a0" aria-label="Null safety가 나온 이유">Null safety가 나온 이유</a></li>
                <li>
                    <a href="#nullable-type%ea%b3%bc-non-nullable-type" aria-label="Nullable type과 non-nullable type">Nullable type과 non-nullable type</a></li>
                <li>
                    <a href="#type-promotion%ea%b3%bc-null-safety" aria-label="Type promotion과 null safety">Type promotion과 null safety</a><ul>
                        
                <li>
                    <a href="#type-promotion" aria-label="Type promotion">Type promotion</a></li>
                <li>
                    <a href="#type-promotion-on-null-checks" aria-label="Type promotion on null checks">Type promotion on null checks</a></li></ul>
                </li>
                <li>
                    <a href="#working-with-nullable-types" aria-label="Working with nullable types">Working with nullable types</a><ul>
                        
                <li>
                    <a href="#null-aware-operator%ec%99%80-short-circuit%eb%8b%a8%eb%9d%bd" aria-label="Null-aware operator와 Short-Circuit(단락)">Null-aware operator와 Short-Circuit(단락)</a></li>
                <li>
                    <a href="#non-null-assertion-operator" aria-label="Non-null assertion operator">Non-null assertion operator</a></li></ul>
                </li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="overview">Overview<a hidden class="anchor" aria-hidden="true" href="#overview">#</a></h2>
<ul>
<li>이 글은 <a href="https://dart.dev/null-safety/understanding-null-safety#nullability-and-generics">Understanding null safety</a> 문서의 내용을 바탕으로 Dart에서 null safety가 나온 배경 및 null safety의 동작 방식을 쉽게 이해하기 위해 작성하였다.</li>
<li>기본 문법적인 설명들을 제외하고 null safety의 원리를 이해하는데 필요하다고 생각되는 부분들만 정리했기 때문에 원문의 일부 내용이 누락되어 있고 설명하는 순서도 다르다.</li>
<li>빠르게 Dart null safety의 동작 방식에 대해 이해하는 것이 목적이라면 이 글을 이해하는 것으로 충분하겠지만, 더 자세한 설명이 필요하다면 원문을 정독하는 것을 권한다.</li>
</ul>
<h2 id="null-safety가-나온-이유">Null safety가 나온 이유<a hidden class="anchor" aria-hidden="true" href="#null-safety가-나온-이유">#</a></h2>
<ul>
<li>Dart에서 <code>null</code>은 <code>Null</code> type으로 표현된다.</li>
<li>Null safety 도입 전에는 Dart type system에서 <code>Null</code>이 다른 모든 type들의 subtype 이었다.
<div align="center"><img src="./image1.png" width="300" /></div>
</li>
<li>그래서 type에 상관 없이 변수에 <code>null</code>을 할당할 수 있었다.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">String</span> value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello&#34;</span>;
</span></span><span style="display:flex;"><span>value <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span></code></pre></div></li>
<li>이렇게 동작할 때 문제는 어떤 변수에 할당된 값이 <code>null</code>인지 아닌지 명확하게 알 수 없다는 것이다.</li>
<li>만약 변수에 <code>null</code>이 할당된 것을 모르고 해당 변수의 값을 참조하면 runtime에 <strong>null reference exception</strong>이 발생하며 app이 crash 될 것이다.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">String</span> value <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>value.length; <span style="color:#75715e">// ❌ : null reference error
</span></span></span></code></pre></div></li>
<li>Null safety는 <strong>nullable한 변수를 null-safe하게 참조할 수 있는 방법</strong>을 제공한다.</li>
</ul>
<h2 id="nullable-type과-non-nullable-type">Nullable type과 non-nullable type<a hidden class="anchor" aria-hidden="true" href="#nullable-type과-non-nullable-type">#</a></h2>
<ul>
<li><strong>Null safety</strong>는 Dart type system의 구조를 변경하여 <code>Null</code> type이 다른 type들의 subtype이 아닌 독립적인 type으로 존재하도록 하여 문제를 해결한다.
<div align="center"><img src="./image2.png" width="300" /></div>
</li>
<li>여기서 <code>Null</code>에 독립적으로 type graph를 이루는 type들을 <strong>non-nullable type</strong>으로 분류한다. Non-nullable type들은 <code>Null</code> type과 연관이 없으므로 절대로 <code>null</code> 값을 가질 수 없다.</li>
<li><code>null</code>값을 가질 수 있는 type들은 <strong>nullable type</strong>으로 분류한다. Nullable type은 underlying type과 <code>Null</code> type의 supertype으로, underlying type 뒤에 <code>?</code> mark를 붙여서 표현한다. 이것은 <strong>nullable type이 non-<code>null</code> 또는 <code>null</code> 값 모두 가질 수 있음을 의미</strong>한다.
<div align="center"><img src="./image3.png" width="230" /></div>
</li>
<li>즉, null safety 도입 이후 Dart의 type은 아래와 같이 <strong>nullable type</strong>과 <strong>non-nullable type</strong> 두 그룹으로 분류된다.
<div align="center"><img src="./image4.png" width="600" /></div>
</li>
</ul>
<h2 id="type-promotion과-null-safety">Type promotion과 null safety<a hidden class="anchor" aria-hidden="true" href="#type-promotion과-null-safety">#</a></h2>
<h3 id="type-promotion">Type promotion<a hidden class="anchor" aria-hidden="true" href="#type-promotion">#</a></h3>
<ul>
<li>Type promotion이란, <code>if</code> 등 control flow에서 <code>is</code> 연산자로 어떤 변수의 type을 특정할 수 있으면 control flow body 안에서 해당 변수의 type을 <code>is</code>로 검사한 type으로 취급(promote)하는 것을 말한다.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">bool</span> isEmptyList(<span style="color:#66d9ef">Object</span> object) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (object <span style="color:#66d9ef">is</span> List) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> object.isEmpty; <span style="color:#75715e">// ✅ : `object`가 `List` type인 것을 안다.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>Null safety가 도입되기 전의 type promotion은 제한적이어서, 아래와 같이 <code>is!</code> 연산자를 사용한 반대 상황에서는 동작하지 않았다.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#75715e">// Without null safety:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">bool</span> isEmptyList(<span style="color:#66d9ef">Object</span> object) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (object <span style="color:#66d9ef">is</span><span style="color:#f92672">!</span> List) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> object.isEmpty; <span style="color:#75715e">// ❌
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li>Null safety를 도입하기 전에는 <code>object</code>가 <code>List</code> type이라는 것을 Dart가 알지 못했기 때문에 위 코드는 실행되지 못했다.</li>
<li>Null safety에 type promotion을 도입하기 전에, 이러한 type promotion의 한계를 먼저 해결했다.</li>
<li>따라서, <strong>위 코드가 동작하려면 null safety를 사용해야 한다.</strong></li>
</ul>
</li>
<li>Null safety를 도입한 후에는 개선된 type promotion을 사용하여 위 코드가 정상적으로 실행될 수 있다.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#75715e">// Using null safety:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">bool</span> isEmptyList(<span style="color:#66d9ef">Object</span> object) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (object <span style="color:#66d9ef">is</span><span style="color:#f92672">!</span> List) <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> object.isEmpty; <span style="color:#75715e">// ✅ : `object`가 `List` type인 것을 안다.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><ul>
<li>기존 type promotion이 early return 및 unreachable code path에 대해서 잘 동작하지 않았던 문제가 개선됐다.</li>
<li>개선된 type promotion은 <code>return</code>, <code>break</code>, <code>throw</code> 및 함수에서 early terminate로 동작하는 code를 인식한다.</li>
</ul>
</li>
</ul>
<h3 id="type-promotion-on-null-checks">Type promotion on null checks<a hidden class="anchor" aria-hidden="true" href="#type-promotion-on-null-checks">#</a></h3>
<ul>
<li>
<p>Type promotion이 <code>is</code> 연산자 외에 <code>== null</code> 및 <code>!= null</code> 구문을 통한 null check도 인식하도록 기능이 추가되었다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#75715e">// Using null safety:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">String</span> makeCommand(<span style="color:#66d9ef">String</span> executable, [List<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span><span style="color:#f92672">&gt;?</span> arguments]) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> result <span style="color:#f92672">=</span> executable;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (arguments <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">+=</span> <span style="color:#e6db74">&#39; &#39;</span> <span style="color:#f92672">+</span> arguments.join(<span style="color:#e6db74">&#39; &#39;</span>); <span style="color:#75715e">// ✅ : `arguments`가 `null`이 아닌 것을 안다.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// or
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Using null safety:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">String</span> makeCommand(<span style="color:#66d9ef">String</span> executable, [List<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">String</span><span style="color:#f92672">&gt;?</span> arguments]) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> result <span style="color:#f92672">=</span> executable;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (arguments <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>) <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39; &#39;</span> <span style="color:#f92672">+</span> arguments.join(<span style="color:#e6db74">&#39; &#39;</span>); <span style="color:#75715e">// ✅ : `arguments`가 `null`이 아닌 것을 안다.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div></li>
<li>
<p>Type promotion은 아래 두 가지 경우에만 사용할 수 있다.</p>
<ol>
<li>Local variable</li>
<li>Private <code>final</code> field (Dart 3.2)</li>
</ol>
</li>
<li>
<p>위 두 가지 조건은 <code>if</code> condition 안에서 <code>null</code>이 아니었는데 control flow body 에서 다시 <code>null</code>이 되는 상황을 만들지 않는 조건이다.</p>
</li>
<li>
<p>간혹 <code>if</code>문 안에서 null check를 했는데도 promotion이 안될 때가 있는데, 이 두 가지 조건을 만족하지 않는 변수 또는 field를 사용했을 것이다. 아래 코드는 <code>_temperature</code>가 <code>final</code> field가 아니기 때문에 promotion이 동작하지 않아 error가 발생한다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#75715e">// Using null safety, incorrectly:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Coffee</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">String</span><span style="color:#f92672">?</span> _temperature;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> checkTemp() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (_temperature <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>      print(<span style="color:#e6db74">&#39;Ready to serve &#39;</span> <span style="color:#f92672">+</span> _temperature <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;!&#39;</span>); <span style="color:#75715e">// ❌ : _temperature isn&#39;t final
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>변수 또는 field를 위 조건을 만족하도록 수정하기 어렵다면, local variable로 한 번 복사하는 pattern을 사용할 수 있다. 실제로 null check를 하는 대상이 local variable이 되어 promotion이 동작할 수 있다.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#75715e">// Using null safety, incorrectly:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Coffee</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">String</span><span style="color:#f92672">?</span> _temperature;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> checkTemp() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> temperature <span style="color:#f92672">=</span> _temperature;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (_temperature <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>      print(<span style="color:#e6db74">&#39;Ready to serve &#39;</span> <span style="color:#f92672">+</span> _temperature <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;!&#39;</span>); <span style="color:#75715e">// ✅
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>Type promotion이 실패했을 때 수정하는 더 자세한 방법은 <a href="https://dart.dev/tools/non-promotion-reasons">Fixing type promotion failures</a> 문서를 참고해 보면 좋다.</p>
</li>
</ul>
<h2 id="working-with-nullable-types">Working with nullable types<a hidden class="anchor" aria-hidden="true" href="#working-with-nullable-types">#</a></h2>
<ul>
<li>Nullable type이 <code>null</code>이 아닌 값을 가지고 있을 때, 이 non-null 값을 안전하게 사용하는 방법들을 정리한다.</li>
</ul>
<h3 id="null-aware-operator와-short-circuit단락">Null-aware operator와 Short-Circuit(단락)<a hidden class="anchor" aria-hidden="true" href="#null-aware-operator와-short-circuit단락">#</a></h3>
<ul>
<li>Null safety 도입 이전에는 null aware operator(<code>?.</code>)를 사용해서 nullable 변수에 저장된 non-null value를 안전하게 사용할 수 있었다.</li>
<li>이 연산자의 왼쪽 receiver가 <code>null</code>을 반환하면 오른쪽 구문의 실행을 건너뛰고 전체 구문을 <code>null</code>로 평가하여 <strong>exception 없이 <code>null</code>을 반환한다</strong>.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#75715e">// With or without null safety:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">String</span> notAString <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>print(notAString<span style="color:#f92672">?</span>.length); <span style="color:#75715e">// null
</span></span></span></code></pre></div></li>
<li>그런데, 아래와 같이 <code>?.</code> 연산자를 연달아 사용하는 경우 문제가 생긴다. 두 번째로 사용된 <code>?.</code> 연산자가 어떤 구문을 위해 사용된 것인지 모호해진다.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#75715e">// Using null safety:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> showGizmo(Thing<span style="color:#f92672">?</span> thing) {
</span></span><span style="display:flex;"><span>  print(thing<span style="color:#f92672">?</span>.doohickey<span style="color:#f92672">?</span>.gizmo);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li><code>doohickey</code>가 nullable field라면 <code>?.</code> 연산자는 <code>doohickey</code>를 위해 사용된 것일 수 있다.</li>
<li><code>doohickey</code>가 non-nullable field라면 <code>?.</code> 연산자는 <code>thing?.doohickey</code>를 위해 사용된 것일 수 있다.</li>
</ul>
</li>
<li>이 문제를 해결하기 위해 receiver가 <code>null</code>로 평가되는 경우 구문의 나머지 chain에 대한 실행을 생략하는 <strong>short-circut</strong> 방식을 사용한다.</li>
<li>이 방법을 사용함으로써 위 코드에서 두 번째 <code>?.</code>는 <code>doohickey</code>가 nullable type이기 때문에 사용된 것임을 알 수 있다.</li>
</ul>
<h3 id="non-null-assertion-operator">Non-null assertion operator<a hidden class="anchor" aria-hidden="true" href="#non-null-assertion-operator">#</a></h3>
<ul>
<li>Nullable type이지만 <code>null</code>이 될 수 없음을 보장할 수 있는 변수는 assertion을 통해 non-null value를 사용할 수 있다.</li>
<li><code>as</code> cast operator를 사용해서 nullable type이 갖고 있는 non-null value를 가져올 수 있다.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">String</span><span style="color:#f92672">?</span> value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello&#34;</span>;
</span></span><span style="display:flex;"><span>(value <span style="color:#f92672">as</span> <span style="color:#66d9ef">String</span>).toUpperCase(); <span style="color:#75715e">// HELLO
</span></span></span></code></pre></div><ul>
<li>Nullable type은 underlying type과 <code>Null</code> type의 supertype 이다.</li>
<li>따라서, nullable type을 underlying type으로 downcasting 할 수 있다.</li>
</ul>
</li>
<li><code>!</code> 연산자는 왼쪽 구문을 underlying type으로 cast해 주는 축약 문법이다. 즉, <code>as</code> cast와 동일하게 동작한다.
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dart" data-lang="dart"><span style="display:flex;"><span><span style="color:#66d9ef">String</span><span style="color:#f92672">?</span> value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;hello&#34;</span>;
</span></span><span style="display:flex;"><span>value<span style="color:#f92672">!</span>.toUpperCase(); <span style="color:#75715e">// HELLO
</span></span></span></code></pre></div></li>
<li>Nullable type 변수에 <code>null</code>이 할당되어 있을 때, <code>as</code> cast는 exception을 발생시키지 않고 <code>null</code>을 반환하지만 <code>!</code> 연산자는 exception을 발생시키므로 사용에 주의한다.</li>
</ul>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<ul>
<li>Dart가 type system을 기반으로 null safety를 지원하는 방식을 깊이 이해할 수 있었다.</li>
<li>이 문서를 통해 flow analysis나 type promotion 등의 개념을 추가로 배울 수 있었다. 각각의 개념들이 null safety를 구현하는데 자주 언급되었기 떄문에 다시 개별적으로 더 공부해야 할 것 같다.</li>
<li>최근 진행한 면접에서 Dart의 type promotion이 가끔 동작하지 않는 이유에 대해 대답하지 못했는데 이 문서를 통해 답을 찾을 수 있었다. Local variable과 private final field에 대해서만 type promotion이 동작한다는 것을 알게 되었으므로, 이제 type promotion이 동작하지 않는 문제를 해결할 수 있다.</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://cskime.github.io/tags/dart/">Dart</a></li>
      <li><a href="https://cskime.github.io/tags/null-safety/">Null Safety</a></li>
      <li><a href="https://cskime.github.io/tags/flow-analysis/">Flow Analysis</a></li>
      <li><a href="https://cskime.github.io/tags/type-promotion/">Type Promotion</a></li>
    </ul>
  </footer>
<div id="disqus_thread"></div>
<script>
  window.disqus_config = function () {
  
  
  
  };
  (function() {
      if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
          document.getElementById('disqus_thread').innerHTML = 'Disqu s comments not available by default when the website is previewed locally.';
          return;
      }
      var d = document, s = d.createElement('script'); s.async = true;
      s.src = '//' + "cskime-github-io" + '.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
  })();
</script>
<noscript
  >Please enable JavaScript to view the
  <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript
>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a
>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2024 <a href="https://cskime.github.io/">cskime.io</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
